# API 要件: ユーザーコード取得エンドポイント (`/ci/builds/:postId/code`) の再設計

**背景:**

現在の CI ワークフロー (`ci-cd-pipeline` リポジトリ) は、ユーザーコードをビルド・デプロイするために、CodeUs! バックエンド API からユーザーコード一式を取得する必要があります。当初、この API エンドポイント (`/ci/builds/:postId/code`) は `tar.gz` 形式でコード一式を返すことを想定していましたが、現状は JSON 形式でファイルリストと内容を返しています。

CI ワークフローの簡潔性、効率性、および一般的なベストプラクティスを考慮し、このエンドポイントが `tar.gz` 形式のアーカイブを返すように再設計することを決定しました。

**対象エンドポイント:**

- `GET /ci/builds/:postId/code`

**現行の動作 (修正前):**

- 指定された `postId` に関連するユーザーコード情報を取得します。
- レスポンスボディとして、以下の形式の JSON を返します。
  ```json
  {
    "codes": [
      {
        "filename": "ファイル名1",
        "content": "ファイル1の内容",
        "language": "言語1"
      }
      // ... 他のファイル
    ]
  }
  ```

**期待される動作 (修正後):**

1.  **認証:**
    - リクエストヘッダーの `Authorization: Bearer <token>` を検証します。
    - 有効な CI 用トークンでない場合は、`401 Unauthorized` を返します。
2.  **コード取得:**
    - 指定された `postId` に関連するユーザーコード情報 (ファイル名と内容) をデータベース等から取得します。
    - 該当する `postId` が存在しない、またはコードが存在しない場合は、`404 Not Found` を返します。
3.  **アーカイブ生成:**
    - 取得したファイル群を **`tar` アーカイブ**としてまとめます。
      - アーカイブ内のファイルパスは、ユーザーが保存した際の相対パス（例: `src/index.js`, `index.html`）を維持する必要があります。
      - 空のディレクトリは含める必要はありません。
4.  **圧縮:**
    - 生成した `tar` アーカイブを **`gzip` で圧縮**します (`.tar.gz` 形式)。
5.  **レスポンス:**
    - レスポンスヘッダーに `Content-Type: application/gzip` を設定します。
    - レスポンスヘッダーに `Content-Disposition: attachment; filename="user-code-${postId}.tar.gz"` のような形式で、ダウンロードファイル名を指定することを推奨します (必須ではありません)。
    - レスポンスボディとして、生成した `tar.gz` ファイルのバイナリデータを返します。
6.  **エラーハンドリング:**
    - アーカイブ生成や圧縮の過程でサーバー内部エラーが発生した場合は、`500 Internal Server Error` を返します。

**CI ワークフロー側の期待:**

修正後の API エンドポイントに対して、CI ワークフローは以下のように動作します。

```bash
# 1. user-code ディレクトリを作成
mkdir -p user-code

# 2. curl で tar.gz をダウンロードし、直接 tar コマンドにパイプして展開
curl -fL -H "Authorization: Bearer <CI_TOKEN>" \
     "https://<API_WORKER_URL>/ci/builds/<postId>/code" | \
     tar xzf - -C user-code

# これにより、user-code ディレクトリ内に API から提供されたファイル構造が展開される
```

**その他:**

- ファイルの内容が非常に大きい場合に備え、ストリーミング処理（データベースから読み込みながら `tar` と `gzip` を行い、レスポンスとして書き出す）を検討してください。メモリ消費量を抑えることができます。

**担当者:**

- [バックエンド担当者名 または チーム名]

**期限:**

- [希望する期限]

ご不明な点があれば、お気軽にご質問ください。
